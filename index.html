-<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consumo de Di√©sel</title>
    <style>
        body { font-family: sans-serif; margin: 0; padding: 20px; background-color: #f4f4f9; }
        h1, h2, h3 { color: #007bff; text-align: center; }
        .container { max-width: 900px; margin: 20px auto; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        form { display: flex; flex-direction: column; gap: 15px; }
        input, select, textarea, button { padding: 10px; border-radius: 4px; border: 1px solid #ddd; font-size: 16px; }
        button { cursor: pointer; border-radius: 4px; }
        button:hover { opacity: 0.9; }
        .main-tabs { border-bottom: 2px solid #007bff; overflow: hidden; }
        .main-tabs button { background-color: #f8f9fa; float: left; border: 1px solid #ccc; border-bottom: none; outline: none; cursor: pointer; padding: 14px 16px; transition: 0.3s; font-size: 17px; border-radius: 8px 8px 0 0; margin-right: 5px; color: #333; }
        .main-tabs button.active { background-color: #007bff; color: white; border-color: #007bff; }
        .main-tab-content { display: none; }
        #historialTabla tfoot tr { font-weight: bold; background-color: #e9ecef; border-top: 2px solid #343a40; }
        .fila-grupo td { background-color: #6c757d; color: white; font-weight: bold; text-align: center; font-size: 1.1em; }
        .filter-section { display: flex; flex-direction: column; gap: 15px; border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 20px; }
        .filter-group { display: flex; flex-wrap: wrap; gap: 15px; align-items: center; }
        @media print {
            body { margin: 0; padding: 10px; background-color: #f0f8ff; /* Fondo azul muy claro */ color: #333; }
            body > *:not(.printable-section) { display: none; }
            .printable-section { display: block !important; }
            .no-print { display: none !important; }
            .container { box-shadow: none; border: 1px solid #ccc; margin: 10px; padding: 15px; border-radius: 5px; background-color: #fff; }
            h1, h2 { color: #008080 !important; /* Verde azulado */ text-align: left; margin-top: 0; }
            h2 { border-bottom: 2px solid #008080; padding-bottom: 5px; margin-bottom: 10px; }
            #historialTabla { width: 100%; border-collapse: collapse; margin-top: 10px; }
            #historialTabla th, #historialTabla td { border: 1px solid #ddd; padding: 8px; text-align: left; }
            #historialTabla th { background-color: #a7d1eb; /* Azul claro */ color: #333; font-weight: bold; }
            #historialTabla tbody tr:nth-child(even) { background-color: #f9f9f9; }
            #historialTabla tfoot tr { background-color: #e0f2f7; /* Verde azulado muy claro */ font-weight: bold; }
            .fila-grupo td { background-color: #80cbc4 !important; /* Verde azulado medio */ color: white !important; font-weight: bold; text-align: center; font-size: 1.1em; }
            .signature-block { display: block; text-align: center; margin-top: 40px; page-break-inside: avoid; }
            .signature-block .line { width: 200px; border-top: 1px solid black; margin: 0 auto 5px auto; }
        }
    </style>
</head>
<body>
    <div class="container no-print">
        <h1>CONSUMO DE DIESEL</h1>
        <div class="filter-section">
            <div class="filter-group">
                <div><label for="filtroMes" style="font-weight: bold;">Por Mes:</label><select id="filtroMes"></select></div>
                <div><label for="filtroFechaInicio" style="font-weight: bold;">Por Rango:</label><input type="date" id="filtroFechaInicio" title="Desde la Fecha"></div>
                <div><label for="filtroFechaFin" style="font-weight: bold;">-</label><input type="date" id="filtroFechaFin" title="Hasta la Fecha"></div>
            </div>
            <div class="filter-group">
                <div><label for="filtroChofer" style="font-weight: bold;">Por Chofer:</label><select id="filtroChofer"></select></div>
                <div><label for="filtroProveedor" style="font-weight: bold;">Por Proveedor:</label><select id="filtroProveedor"></select></div>
                <div><label for="filtroEmpresa" style="font-weight: bold;">Por Empresa:</label><select id="filtroEmpresa"></select></div>
                <div><label for="filtroProyecto" style="font-weight: bold;">Por Proyecto:</label><select id="filtroProyecto"></select></div>
            </div>
             <div class="filter-group">
                 <button id="btnAplicarFiltros" style="background-color: #28a745; color: white; border: none;">Aplicar Filtros</button>
                 <button id="btnLimpiarFiltros" style="background-color: #6c757d; color: white; border: none;">Limpiar Filtros</button>
                 <button id="btnPrint" style="background-color: #17a2b8; color: white; padding: 10px 20px; border: none; margin-left: auto;">üñ®Ô∏è Imprimir Reporte</button>
            </div>
        </div>
    </div>

    <div class="container no-print">
        <div class="main-tabs">
            <button class="main-tab-link active" id="btnTabRegistrar">Registrar</button>
            <button class="main-tab-link" id="btnTabReportes">Reportes</button>
            <button class="main-tab-link" id="btnTabAdmin">Administraci√≥n</button>
        </div>
    </div>

    <div id="tabRegistrar" class="main-tab-content no-print" style="display: block;">
        <div class="container" id="formularioContainer">
            <h2 id="formularioTitulo">Nuevo Registro</h2>
            <form id="consumoForm">
                <input type="hidden" id="registroId">
                <label for="fecha">Fecha:</label><input type="date" id="fecha" required>
                <label for="selectChofer">Nombre del Chofer:</label><select id="selectChofer" required></select>
                <label for="selectVolqueta">Placa de la Volqueta:</label><select id="selectVolqueta" required></select>
                <label for="selectProveedor">Proveedor de Diesel:</label><select id="selectProveedor" required></select>
                <label for="selectProyecto">Proyecto:</label><select id="selectProyecto" required></select>
                <label for="galones">Galones de Di√©sel (Volumen):</label><input type="number" id="galones" step="0.01" required>
                <label for="costo">Costo Total ($):</label><input type="number" id="costo" step="0.01" required>
                <label for="selectEmpresa">Empresa:</label><select id="selectEmpresa" required></select>
                <label for="descripcion">Descripci√≥n del Uso:</label><textarea id="descripcion" required></textarea>
                <button type="submit" id="btnGuardar" style="background-color: #007bff; color: white; border: none;">Guardar Registro</button>
            </form>
        </div>
    </div>

    <div id="tabReportes" class="main-tab-content printable-section">
        <div class="container" id="loaderContainer"><h2 id="loadingMessage" class="loader">Cargando datos desde la nube...</h2></div>
        <div class="container">
            <h2>TOTAL DE CONSUMO DE DIESEL</h2>
            <table id="historialTabla">
                <thead><tr><th>Fecha</th><th>Chofer</th><th>Placa</th><th>Proveedor</th><th>Proyecto</th><th>Galones</th><th>Costo ($)</th><th>Empresa</th><th>Descripci√≥n</th></tr></thead>
                <tbody id="historialBody"></tbody>
                <tfoot id="historialFooter"></tfoot>
            </table>
        </div>
    </div>

    <div id="tabAdmin" class="main-tab-content no-print">
        <div class="container" id="adminContainer">
            <h2>Administraci√≥n</h2>
            <div class="admin-section" style="display: flex; flex-wrap: wrap; justify-content: space-between; gap: 20px;">
                <div class="admin-box" style="flex: 1; min-width: 300px;"><h3>Gestionar Choferes</h3><form id="formAdminChofer" class="admin-form" style="display: flex; gap: 10px; margin-bottom: 15px;"><input type="text" id="nuevoChofer" placeholder="Nombre completo" required style="flex-grow: 1;"><button type="submit" style="background-color: #28a745; color: white; border: none;">Agregar</button></form><ul id="listaChoferes" class="lista-gestion" style="list-style-type: none; padding: 0;"></ul></div>
                <div class="admin-box" style="flex: 1; min-width: 300px;"><h3>Gestionar Placas</h3><form id="formAdminPlaca" class="admin-form" style="display: flex; gap: 10px; margin-bottom: 15px;"><input type="text" id="nuevaPlaca" placeholder="Placa de la volqueta" required style="flex-grow: 1;"><button type="submit" style="background-color: #28a745; color: white; border: none;">Agregar</button></form><ul id="listaPlacas" class="lista-gestion" style="list-style-type: none; padding: 0;"></ul></div>
                <div class="admin-box" style="flex: 1; min-width: 300px;"><h3>Gestionar Empresas</h3><form id="formAdminEmpresa" class="admin-form" style="display: flex; gap: 10px; margin-bottom: 15px;"><input type="text" id="nuevaEmpresa" placeholder="Nombre de la empresa" required style="flex-grow: 1;"><button type="submit" style="background-color: #28a745; color: white; border: none;">Agregar</button></form><ul id="listaEmpresas" class="lista-gestion" style="list-style-type: none; padding: 0;"></ul></div>
                <div class="admin-box" style="flex: 1; min-width: 300px;"><h3>Gestionar Proveedores</h3><form id="formAdminProveedor" class="admin-form" style="display: flex; gap: 10px; margin-bottom: 15px;"><input type="text" id="nuevoProveedor" placeholder="Nombre del proveedor" required style="flex-grow: 1;"><button type="submit" style="background-color: #28a745; color: white; border: none;">Agregar</button></form><ul id="listaProveedores" class="lista-gestion" style="list-style-type: none; padding: 0;"></ul></div>
                <div class="admin-box" style="flex: 1; min-width: 300px;"><h3>Gestionar Proyectos</h3><form id="formAdminProyecto" class="admin-form" style="display: flex; gap: 10px; margin-bottom: 15px;"><input type="text" id="nuevoProyecto" placeholder="Nombre del proyecto" required style="flex-grow: 1;"><button type="submit" style="background-color: #28a745; color: white; border: none;">Agregar</button></form><ul id="listaProyectos" class="lista-gestion" style="list-style-type: none; padding: 0;"></ul></div>
            </div>
        </div>
    </div>
    
    <div class="signature-block printable-section">
        <div class="line"></div>
        Ing. Jos√© L. Macas P.<br>
        RESIDENTE DE OBRA
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, addDoc, updateDoc, deleteDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyCElg_et8_Z8ERTWo5tAwZJk2tb2ztUwlc",
            authDomain: "jlmp-diesel.firebaseapp.com",
            projectId: "jlmp-diesel",
            storageBucket: "jlmp-diesel.firebasestorage.app",
            messagingSenderId: "763318949751",
            appId: "1:763318949751:web:e712d1008d34fbc98ab372"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        let todosLosConsumos = [];
        let listasAdmin = { choferes: [], placas: [], empresas: [], proveedores: [], proyectos: [] };

        function openMainTab(evt, tabName) {
            let i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("main-tab-content");
            for (i = 0; i < tabcontent.length; i++) { tabcontent