<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consumo de Diésel</title>
    
    <link rel="icon" type="image/png" href="logo.png"> 
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="header-container">
        <div class="header-content">
            <img src="logo.jpg" alt="Logo Obreco" class="header-logo">
            <div class="header-titles">
                <h1>GRUPO OBRECO CIA LTDA</h1>
                <h2>CONTROL DE DIESEL</h2>
            </div>
        </div>
        <button id="btn-logout" class="button-danger no-print" style="display: none;"><i class="fa-solid fa-right-from-bracket"></i>Cerrar Sesión</button>
    </div>

    <div class="container no-print">
        <div class="main-tabs">
            <button class="main-tab-link active" id="btnTabInicio"><i class="fa-solid fa-house"></i>Inicio</button>
            <button class="main-tab-link" id="btnTabRegistrar"><i class="fa-solid fa-pencil"></i>Registrar</button>
            <button class="main-tab-link" id="btnTabDistribuir"><i class="fa-solid fa-sitemap"></i>Distribución</button>
            <button class="main-tab-link" id="btnTabReportes"><i class="fa-solid fa-chart-pie"></i>Reportes</button>
            <button class="main-tab-link" id="btnTabHistorial"><i class="fa-solid fa-list-ul"></i>Historial Detallado</button>
            <button class="main-tab-link" id="btnTabAdmin"><i class="fa-solid fa-gear"></i>Administración</button>
        </div>
    </div>

    <div id="main-content-area">
        <div id="vista-login">
            <div class="login-container">
                <form id="login-form">
                    <h3>Iniciar Sesión</h3>
                    <input type="email" id="login-email" placeholder="Correo electrónico" required>
                    <input type="password" id="login-password" placeholder="Contraseña" required>
                    <button type="submit" class="button-primary">Ingresar</button>
                </form>
            </div>
        </div>

        <div id="vista-app" style="display: none;">

            <div id="tabInicio" class="main-tab-content" style="display: block;">
                <div class="container">
                    <h2 style="text-align: left;">Bienvenido a su Panel de Control</h2>
                    
                    <div class="summary-container">
                        <div class="summary-card">
                            <span>Volumen Total (Semana Actual)</span>
                            <h3 id="resumenSemanaGalones">0.00 Gal</h3>
                        </div>
                        <div class="summary-card">
                            <span>Costo Total (Semana Actual)</span>
                            <h3 id="resumenSemanaCosto">$ 0.00</h3>
                        </div>
                        <div class="summary-card">
                            <span>Volumen Total (Mes Actual)</span>
                            <h3 id="resumenMesGalones">0.00 Gal</h3>
                        </div>
                        <div class="summary-card">
                            <span>Costo Total (Mes Actual)</span>
                            <h3 id="resumenMesCosto">$ 0.00</h3>
                        </div>
                    </div>

                    <div class="dashboard-grid">
                        <button id="btnDashRegistrar" class="nav-button button-primary">
                            <i class="fa-solid fa-pencil"></i>
                            <span>Registrar Nueva Carga</span>
                        </button>
                        <button id="btnDashHistorial" class="nav-button button-info">
                            <i class="fa-solid fa-list-ul"></i>
                            <span>Ver Reporte Detallado</span>
                        </button>
                        <button id="btnDashAdmin" class="nav-button button-secondary">
                            <i class="fa-solid fa-gear"></i>
                            <span>Administrar Base de Datos</span>
                        </button>
                        <button id="btnDashImprimir" class="nav-button button-primary">
                            <i class="fa-solid fa-print"></i>
                            <span>Imprimir Reporte Mensual</span>
                        </button>
                    </div>
                </div>
            </div>
            
            <div id="tabRegistrar" class="main-tab-content no-print">
                <div class="container">
                    <h2><i class="fa-solid fa-file-circle-plus"></i>Registros de Consumo</h2>
                    <p>Haz clic en el botón para añadir un nuevo registro de consumo de diésel.</p>
                    <button id="btnAbrirModal" class="button-primary"><i class="fa-solid fa-plus"></i>Nuevo Registro</button>
                </div>
                <div id="modalRegistro" class="modal">
                    <div class="modal-content">
                        <span class="close-button">&times;</span>
                        <div id="formularioContainer">
                            <h2 id="formularioTitulo">Nuevo Registro</h2>
                            <form id="consumoForm">
                                <input type="hidden" id="registroId">
                                <label for="fecha">Fecha:</label>
                                <input type="date" id="fecha" required>
                                <label for="hora">Hora de Carga:</label>
                                <input type="time" id="hora">
                                <label for="selectChofer">Nombre del Chofer:</label>
                                <select id="selectChofer" required></select>
                                <label for="selectVolqueta">Placa de la Volqueta:</label>
                                <select id="selectVolqueta" required></select>
                                <label for="selectDetallesVolqueta">Detalles Volqueta:</label>
                                <select id="selectDetallesVolqueta"></select> 
                                <label for="kilometraje">Kilometraje:</label>
                                <input type="number" id="kilometraje" step="any" placeholder="Ej: 150230.5">
                                <label for="selectProveedor">Proveedor de Diesel:</label>
                                <select id="selectProveedor" required></select>
                                <label for="selectProyecto">Proyecto:</label>
                                <select id="selectProyecto" required></select>
                                <label for="galones">Galones de Diésel (Volumen):</label>
                                <input type="number" id="galones" step="0.01" required>
                                <label for="costo">Costo Total ($):</label>
                                <input type="number" id="costo" step="0.01" required>
                                <label for="selectEmpresa">Empresa:</label>
                                <select id="selectEmpresa" required></select>
                                <label for="descripcion">Descripción del Uso:</label>
                                <textarea id="descripcion" required></textarea>
                                <button type="submit" id="btnGuardar" class="button-primary"><i class="fa-solid fa-floppy-disk"></i>Guardar Registro</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="tabDistribuir" class="main-tab-content no-print">
                <div class="container">
                    <h2><i class="fa-solid fa-sitemap"></i>Distribución de Consumo por Proyecto</h2>
                    <p>Ingrese los datos de la carga y distribuya el consumo. **Haga clic en 'Previsualizar y Distribuir' antes de Guardar.**</p>
                    
                    <div id="formularioContainerDistribucion">
                        <h3 style="text-align: left;">Datos del Registro Único</h3>
                        <form id="distribucionForm">
                            <input type="hidden" id="distribucionRegistroId">
                            
                            <div class="form-grid">
                                <div>
                                    <label for="distribucionFecha">Fecha:</label>
                                    <input type="date" id="distribucionFecha" required>
                                </div>
                                <div>
                                    <label for="distribucionHora">Hora de Carga:</label>
                                    <input type="time" id="distribucionHora">
                                </div>
                                <div>
                                    <label for="distribucionSelectChofer">Nombre del Chofer:</label>
                                    <select id="distribucionSelectChofer" required></select>
                                </div>
                                <div>
                                    <label for="distribucionSelectVolqueta">Placa de la Volqueta:</label>
                                    <select id="distribucionSelectVolqueta" required></select>
                                </div>
                                <div>
                                    <label for="distribucionSelectProveedor">Proveedor de Diesel:</label>
                                    <select id="distribucionSelectProveedor" required></select>
                                </div>
                                <div>
                                    <label for="distribucionSelectProyecto">Proyecto (Si no se distribuye):</label>
                                    <select id="distribucionSelectProyecto"></select>
                                </div>
                                <div>
                                    <label for="distribucionGalonesTotal">Galones de Diésel (TOTAL):</label>
                                    <input type="number" id="distribucionGalonesTotal" step="0.01" required>
                                </div>
                                <div>
                                    <label for="distribucionCostoTotal">Costo Total ($):</label>
                                    <input type="number" id="distribucionCostoTotal" step="0.01" required>
                                </div>
                                </div>

                            <hr style="margin: 20px 0;">
                            
                            <h3 style="text-align: left;">Distribución por Proyecto (Sólo si es multi-proyecto)</h3>
                            <div id="distribucionProyectosContainer" class="form-grid" style="grid-template-columns: 1fr 1fr 1fr;">
                                <div id="distribucionTotales" style="grid-column: 1 / -1; display: flex; justify-content: space-between; font-weight: bold; margin-top: 10px; border-top: 1px dashed #ccc; padding-top: 10px;">
                                    <span>Galones Pendientes: <span id="galonesPendientes" style="color: red;">0.00</span></span>
                                    <span>Costo Pendiente: <span id="costoPendiente" style="color: red;">$ 0.00</span></span>
                                </div>
                            </div>

                            <div id="tablaDistribucionPreview" style="margin-top: 20px; display: none;">
                                <h3 style="text-align: left; border-bottom: 2px solid var(--primary-color); padding-bottom: 5px;">✅ Registros a Guardar (Previsualización)</h3>
                                <div class="table-container">
                                    <table id="previewTable" class="table-striped">
                                        <thead>
                                            <tr>
                                                <th>Proyecto</th>
                                                <th>Galones</th>
                                                <th>Costo ($)</th>
                                                <th>Fecha/Hora</th>
                                                <th>Volqueta</th>
                                            </tr>
                                        </thead>
                                        <tbody id="previewTableBody">
                                            </tbody>
                                    </table>
                                </div>
                                <p style="margin-top: 15px; font-weight: bold; color: var(--danger-color);" id="previewValidationMessage"></p>
                                <button type="button" id="btnConfirmarGuardado" class="button-success" style="width: 100%; margin-top: 15px;"><i class="fa-solid fa-cloud-upload-alt"></i> Confirmar y Guardar Registros</button>
                            </div>
                            
                            <button type="button" id="btnPrevisualizarDistribucion" class="button-info" style="width: 100%; margin-top: 20px;"><i class="fa-solid fa-eye"></i> Previsualizar y Distribuir</button>
                            <button type="button" id="btnCancelarPreview" class="button-secondary" style="width: 100%; margin-top: 10px; display: none;"><i class="fa-solid fa-undo"></i> Editar Distribución</button>

                        </form>
                    </div>
                </div>
            </div>
            <div id="tabReportes" class="main-tab-content"><div class="container no-print"><div class="filter-section"><div class="filter-group"><div><label for="filtroMesReportes">Por Mes:</label><select id="filtroMesReportes" class="filtro-sincronizado" data-sync-id="filtroMes"></select></div><div><label for="filtroFechaInicioReportes">Por Rango:</label><input type="date" id="filtroFechaInicioReportes" class="filtro-sincronizado" data-sync-id="filtroFechaInicio" title="Desde la Fecha"></div><div><label for="filtroFechaFinReportes">-</label><input type="date" id="filtroFechaFinReportes" class="filtro-sincronizado" data-sync-id="filtroFechaFin" title="Hasta la Fecha"></div></div><div class="filter-group"><div><label for="filtroChoferReportes">Por Chofer:</label><select id="filtroChoferReportes" class="filtro-sincronizado" data-sync-id="filtroChofer"></select></div><div><label for="filtroProveedorReportes">Por Proveedor:</label><select id="filtroProveedorReportes" class="filtro-sincronizado" data-sync-id="filtroProveedor"></select></div><div><label for="filtroEmpresaReportes">Por Empresa:</label><select id="filtroEmpresaReportes" class="filtro-sincronizado" data-sync-id="filtroEmpresa"></select></div><div><label for="filtroProyectoReportes">Por Proyecto:</label><select id="filtroProyectoReportes" class="filtro-sincronizado" data-sync-id="filtroProyecto"></select></div></div><div class="filter-group"><button id="btnAplicarFiltros" class="button-success"><i class="fa-solid fa-filter"></i>Aplicar Filtros</button><button id="btnLimpiarFiltros" class="button-secondary"><i class="fa-solid fa-eraser"></i>Limpiar Filtros</button><button class="button-info btn-print" data-print-target="tabReportes" style="margin-left: auto;"><i class="fa-solid fa-print"></i>Imprimir Reporte</button></div></div></div><div class="container" id="loaderContainer"><h2 id="loadingMessage" class="loader">Cargando datos desde la nube...</h2></div><div class="container report-cards-container"><div class="report-card"><div class="card-header"><i class="fa-solid fa-building"></i><h3>Por Empresa</h3></div><div class="card-body"><table id="resumenEmpresaTabla"><thead><tr><th>Empresa</th><th>Galones</th><th>Costo ($)</th></tr></thead><tbody id="resumenEmpresaBody"></tbody><tfoot id="resumenEmpresaFooter"></tfoot></table></div></div><div class="report-card"><div class="card-header"><i class="fa-solid fa-dolly"></i><h3>Por Proveedor</h3></div><div class="card-body"><table id="resumenProveedorTabla"><thead><tr><th>Proveedor</th><th>Galones</th><th>Costo ($)</th></tr></thead><tbody id="resumenProveedorBody"></tbody><tfoot id="resumenProveedorFooter"></tfoot></table></div></div><div class="report-card"><div class="card-header"><i class="fa-solid fa-list-check"></i><h3>Por Proyecto</h3></div><div class="card-body"><table id="resumenProyectoTabla"><thead><tr><th>Proyecto</th><th>Galones</th><th>Costo ($)</th></tr></thead><tbody id="resumenProyectoBody"></tbody><tfoot id="resumenProyectoFooter"></tfoot></table></div></div><div class="report-card"><div class="card-header"><i class="fa-solid fa-user-tie"></i><h3>Por Chofer</h3></div><div class="card-body"><table id="resumenChoferTabla"><thead><tr><th>Chofer</th><th>Galones</th><th>Costo ($)</th></tr></thead><tbody id="resumenChoferBody"></tbody><tfoot id="resumenChoferFooter"></tfoot></table></div></div><div class="report-card"><div class="card-header"><i class="fa-solid fa-truck"></i><h3>Por Placa</h3></div><div class="card-body"><table id="resumenTabla"><thead><tr><th>Placa</th><th>Galones</th><th>Costo ($)</th></tr></thead><tbody id="resumenBody"></tbody><tfoot id="resumenFooter"></tfoot></table></div></div></div></div>

            <div id="tabHistorial" class="main-tab-content">
                <div class="container no-print"><div class="filter-section"><div class="filter-group"><div><label for="filtroMesHistorial">Por Mes:</label><select id="filtroMesHistorial" class="filtro-sincronizado" data-sync-id="filtroMes"></select></div><div><label for="filtroFechaInicioHistorial">Por Rango:</label><input type="date" id="filtroFechaInicioHistorial" class="filtro-sincronizado" data-sync-id="filtroFechaInicio" title="Desde la Fecha"></div><div><label for="filtroFechaFinHistorial">-</label><input type="date" id="filtroFechaFinHistorial" class="filtro-sincronizado" data-sync-id="filtroFechaFin" title="Hasta la Fecha"></div></div><div class="filter-group"><div><label for="filtroChoferHistorial">Por Chofer:</label><select id="filtroChoferHistorial" class="filtro-sincronizado" data-sync-id="filtroChofer"></select></div><div><label for="filtroProveedorHistorial">Por Proveedor:</label><select id="filtroProveedorHistorial" class="filtro-sincronizado" data-sync-id="filtroProveedor"></select></div><div><label for="filtroEmpresaHistorial">Por Empresa:</label><select id="filtroEmpresaHistorial" class="filtro-sincronizado" data-sync-id="filtroEmpresa"></select></div><div><label for="filtroProyectoHistorial">Por Proyecto:</label><select id="filtroProyectoHistorial" class="filtro-sincronizado" data-sync-id="filtroProyecto"></select></div></div>
                    <div class="filter-group">
                        <button id="btnAplicarFiltros" class="button-success"><i class="fa-solid fa-filter"></i>Aplicar Filtros</button>
                        <button id="btnLimpiarFiltros" class="button-secondary"><i class="fa-solid fa-eraser"></i>Limpiar Filtros</button>
                        <button class="button-info btn-print" data-print-target="tabHistorial" style="margin-left: auto;"><i class="fa-solid fa-print"></i>Imprimir Historial</button>
                    </div>
                    <small class="print-suggestion no-print">Sugerencia: Para mejor visualización, configure la impresión en orientación Horizontal.</small>
                    </div></div>
                <div class="container">
                    <button class="accordion-button active">TOTAL DE CONSUMO DE DIESEL (HISTORIAL DETALLADO)</button>
                    <div class="accordion-panel" style="max-height: fit-content;">
                        <div class="table-container">
                            <table id="historialTabla">
                                <thead>
                                    <tr>
                                        <th class="no-print">Acciones</th>
                                        <th>Fecha</th>
                                        <th>Hora</th>
                                        <th>Chofer</th>
                                        <th>Placa</th>
                                        <th>Detalles Volqueta</th>
                                        <th>Kilometraje</th>
                                        <th>Proveedor</th>
                                        <th>Proyecto</th>
                                        <th>Galones</th>
                                        <th>Costo ($)</th>
                                        <th>Empresa</th>
                                        <th>Descripción</th>
                                    </tr>
                                </thead>
                                <tbody id="historialBody"></tbody>
                                <tfoot id="historialFooter"></tfoot>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div id="tabAdmin" class="main-tab-content no-print">
                <div class="container" id="adminContainer"><h2><i class="fa-solid fa-screwdriver-wrench"></i>Administración</h2><div class="admin-section"><div class="admin-box"><h3><i class="fa-solid fa-user-tie"></i>Gestionar Choferes</h3><form id="formAdminChofer" class="admin-form"><input type="text" id="nuevoChofer" placeholder="Nombre del chofer" required><button type="submit" class="button-success"><i class="fa-solid fa-plus"></i>Agregar</button></form><ul id="listaChoferes" class="lista-gestion"></ul></div><div class="admin-box"><h3><i class="fa-solid fa-truck"></i>Gestionar Placas</h3><form id="formAdminPlaca" class="admin-form"><input type="text" id="nuevaPlaca" placeholder="Placa de la volqueta" required><button type="submit" class="button-success"><i class="fa-solid fa-plus"></i>Agregar</button></form><ul id="listaPlacas" class="lista-gestion"></ul></div><div class="admin-box"><h3><i class="fa-solid fa-tags"></i>Gestionar Detalles Volqueta</h3><form id="formAdminDetallesVolqueta" class="admin-form"><input type="text" id="nuevoDetalleVolqueta" placeholder="Ej: Doble Eje, Tritón Rojo" required><button type="submit" class="button-success"><i class="fa-solid fa-plus"></i>Agregar</button></form><ul id="listaDetallesVolqueta" class="lista-gestion"></ul></div><div class="admin-box"><h3><i class="fa-solid fa-building"></i>Gestionar Empresas</h3><form id="formAdminEmpresa" class="admin-form"><input type="text" id="nuevaEmpresa" placeholder="Nombre de la empresa" required><button type="submit" class="button-success"><i class="fa-solid fa-plus"></i>Agregar</button></form><ul id="listaEmpresas" class="lista-gestion"></ul></div><div class="admin-box"><h3><i class="fa-solid fa-dolly"></i>Gestionar Proveedores</h3><form id="formAdminProveedor" class="admin-form"><input type="text" id="nuevoProveedor" placeholder="Nombre del proveedor" required><button type="submit" class="button-success"><i class="fa-solid fa-plus"></i>Agregar</button></form><ul id="listaProveedores" class="lista-gestion"></ul></div><div class="admin-box"><h3><i class="fa-solid fa-list-check"></i>Gestionar Proyectos</h3><form id="formAdminProyecto" class="admin-form"><input type="text" id="nuevoProyecto" placeholder="Nombre del proyecto" required><button type="submit" class="button-success"><i class="fa-solid fa-plus"></i>Agregar</button></form><ul id="listaProyectos" class="lista-gestion"></ul></div></div></div>
            </div>
            
            <div class="signature-block"><div class="line"></div>Ing. José L. Macas P.<br>RESIDENTE DE OBRA</div>

            <div class="credits">
                APLICACION ELABORADA POR: ING. JOSE LUIS MACAS P.
            </div>
        </div>
    </div>
    
    <div id="facturas-impresion"></div>

    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script type="module" src="script.js"></script>
</body>
</html>