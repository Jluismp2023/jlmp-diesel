<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consumo de Di√©sel</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: sans-serif; margin: 0; padding: 20px; background-color: #f4f4f9; }
        h1, h2, h3 { color: #007bff; text-align: center; }
        .container { max-width: 900px; margin: 20px auto; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        form { display: flex; flex-direction: column; gap: 15px; }
        input, select, textarea, button { padding: 10px; border-radius: 4px; border: 1px solid #ddd; font-size: 16px; }
        button { cursor: pointer; border-radius: 4px; }
        button:hover { opacity: 0.9; }
        .main-tabs { border-bottom: 2px solid #007bff; overflow: hidden; }
        .main-tabs button { background-color: #f8f9fa; float: left; border: 1px solid #ccc; border-bottom: none; outline: none; cursor: pointer; padding: 14px 16px; transition: 0.3s; font-size: 17px; border-radius: 8px 8px 0 0; margin-right: 5px; color: #333; }
        .main-tabs button.active { background-color: #007bff; color: white; border-color: #007bff; }
        .main-tab-content { display: none; }
        #resumenTabla th, #resumenEmpresaTabla th, #resumenProveedorTabla th { background-color: #28a745; }
        #resumenTabla tfoot tr, #resumenEmpresaTabla tfoot tr, #resumenProveedorTabla tfoot tr { font-weight: bold; background-color: #e9ecef; border-top: 2px solid #343a40; }
        .fila-grupo td { background-color: #6c757d; color: white; font-weight: bold; text-align: center; font-size: 1.1em; }
        @media print { /* Estilos de Impresi√≥n */ }
    </style>
</head>
<body>
    <div class="container no-print">
        <h1>CONSUMO DE DIESEL</h1>
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
            <div><label for="filtroMes" style="font-weight: bold;">Filtrar por Mes:</label><select id="filtroMes"></select></div>
            <button id="btnPrint" style="background-color: #17a2b8; color: white; padding: 10px 20px; border: none;">üñ®Ô∏è Imprimir Reporte</button>
        </div>
    </div>

    <div class="container no-print">
        <div class="main-tabs">
            <button class="main-tab-link active" id="btnTabRegistrar">Registrar</button>
            <button class="main-tab-link" id="btnTabReportes">Reportes</button>
            <button class="main-tab-link" id="btnTabAdmin">Administraci√≥n</button>
        </div>
    </div>

    <div id="tabRegistrar" class="main-tab-content no-print" style="display: block;">
        <div class="container" id="formularioContainer">
            <h2 id="formularioTitulo">Nuevo Registro</h2>
            <form id="consumoForm">
                <input type="hidden" id="registroId">
                <label for="fecha">Fecha:</label><input type="date" id="fecha" required>
                <label for="selectChofer">Nombre del Chofer:</label><select id="selectChofer" required></select>
                <label for="selectVolqueta">Placa de la Volqueta:</label><select id="selectVolqueta" required></select>
                <label for="selectProveedor">Proveedor de Diesel:</label><select id="selectProveedor" required></select>
                <label for="galones">Galones de Di√©sel (Volumen):</label><input type="number" id="galones" step="0.01" required>
                <label for="costo">Costo Total ($):</label><input type="number" id="costo" step="0.01" required>
                <label for="selectEmpresa">Empresa:</label><select id="selectEmpresa" required></select>
                <label for="descripcion">Descripci√≥n del Uso:</label><textarea id="descripcion" required></textarea>
                <button type="submit" id="btnGuardar" style="background-color: #007bff; color: white; border: none;">Guardar Registro</button>
            </form>
        </div>
    </div>

    <div id="tabReportes" class="main-tab-content printable-section">
        <div class="container" id="loaderContainer"><h2 id="loadingMessage" class="loader">Cargando datos desde la nube...</h2></div>
        <div class="container"><h2>CONSUMO DE DIESEL POR EMPRESA</h2><table id="resumenEmpresaTabla"><thead><tr><th>Empresa</th><th>Total Galones (Volumen)</th><th>Costo Total ($)</th></tr></thead><tbody id="resumenEmpresaBody"></tbody><tfoot id="resumenEmpresaFooter"></tfoot></table></div>
        <div class="container"><h2>CONSUMO DE DIESEL POR PROVEEDOR</h2><table id="resumenProveedorTabla"><thead><tr><th>Proveedor</th><th>Total Galones (Volumen)</th><th>Costo Total ($)</th></tr></thead><tbody id="resumenProveedorBody"></tbody><tfoot id="resumenProveedorFooter"></tfoot></table></div>
        <div class="container"><h2>CONSUMO DE DIESEL POR PLACA</h2><table id="resumenTabla"><thead><tr><th>Volqueta (Placa)</th><th>Total Galones (Volumen)</th><th>Costo Total ($)</th></tr></thead><tbody id="resumenBody"></tbody><tfoot id="resumenFooter"></tfoot></table></div>
        <div class="container"><h2>TOTAL DE CONSUMO DE DIESEL</h2><table id="historialTabla"><thead><tr><th>Fecha</th><th>Chofer</th><th>Placa</th><th>Proveedor</th><th>Galones</th><th>Costo ($)</th><th>Empresa</th><th>Descripci√≥n</th><th class="no-print">Acciones</th></tr></thead><tbody id="historialBody"></tbody></table></div>
        <div class="container"><h2>Consumo por Placa</h2><canvas id="graficoConsumo" style="max-height: 400px;"></canvas></div>
    </div>

    <div id="tabAdmin" class="main-tab-content no-print">
        <div class="container" id="adminContainer">
            <h2>Administraci√≥n</h2>
            <div class="admin-section" style="display: flex; flex-wrap: wrap; justify-content: space-between; gap: 20px;">
                <div class="admin-box" style="flex: 1; min-width: 300px;"><h3>Gestionar Choferes</h3><form id="formAdminChofer" class="admin-form" style="display: flex; gap: 10px; margin-bottom: 15px;"><input type="text" id="nuevoChofer" placeholder="Nombre completo" required style="flex-grow: 1;"><button type="submit" style="background-color: #28a745; color: white; border: none;">Agregar</button></form><ul id="listaChoferes" class="lista-gestion" style="list-style-type: none; padding: 0;"></ul></div>
                <div class="admin-box" style="flex: 1; min-width: 300px;"><h3>Gestionar Placas</h3><form id="formAdminPlaca" class="admin-form" style="display: flex; gap: 10px; margin-bottom: 15px;"><input type="text" id="nuevaPlaca" placeholder="Placa de la volqueta" required style="flex-grow: 1;"><button type="submit" style="background-color: #28a745; color: white; border: none;">Agregar</button></form><ul id="listaPlacas" class="lista-gestion" style="list-style-type: none; padding: 0;"></ul></div>
                <div class="admin-box" style="flex: 1; min-width: 300px;"><h3>Gestionar Empresas</h3><form id="formAdminEmpresa" class="admin-form" style="display: flex; gap: 10px; margin-bottom: 15px;"><input type="text" id="nuevaEmpresa" placeholder="Nombre de la empresa" required style="flex-grow: 1;"><button type="submit" style="background-color: #28a745; color: white; border: none;">Agregar</button></form><ul id="listaEmpresas" class="lista-gestion" style="list-style-type: none; padding: 0;"></ul></div>
                <div class="admin-box" style="flex: 1; min-width: 300px;"><h3>Gestionar Proveedores</h3><form id="formAdminProveedor" class="admin-form" style="display: flex; gap: 10px; margin-bottom: 15px;"><input type="text" id="nuevoProveedor" placeholder="Nombre del proveedor" required style="flex-grow: 1;"><button type="submit" style="background-color: #28a745; color: white; border: none;">Agregar</button></form><ul id="listaProveedores" class="lista-gestion" style="list-style-type: none; padding: 0;"></ul></div>
            </div>
        </div>
    </div>
    
    <div class="signature-block printable-section">
        <div class="line" style="width: 250px; border-top: 1px solid black; margin: 80px auto 10px auto;"></div>
        Ing. Jos√© L. Macas P.<br>
        RESIDENTE DE OBRA
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, addDoc, updateDoc, deleteDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyCElg_et8_Z8ERTWo5tAwZJk2tb2ztUwlc",
            authDomain: "jlmp-diesel.firebaseapp.com",
            projectId: "jlmp-diesel",
            storageBucket: "jlmp-diesel.firebasestorage.app",
            messagingSenderId: "763318949751",
            appId: "1:763318949751:web:e712d1008d34fbc98ab372"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        let miGrafico = null;
        let filtroMesActual = 'todos';
        let todosLosConsumos = [];
        let listasAdmin = { choferes: [], placas: [], empresas: [], proveedores: [] };

        // --- DECLARACI√ìN DE TODAS LAS FUNCIONES ---
        // (La correcci√≥n es declarar todas las funciones antes de usarlas)

        function openMainTab(evt, tabName) {
            let i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("main-tab-content");
            for (i = 0; i < tabcontent.length; i++) { tabcontent[i].style.display = "none"; }
            tablinks = document.getElementsByClassName("main-tab-link");
            for (i = 0; i < tablinks.length; i++) { tablinks[i].className = tablinks[i].className.replace(" active", ""); }
            document.getElementById(tabName).style.display = "block";
            evt.currentTarget.className += " active";
        }

        function poblarSelectores() {
            const selectores = { choferes: document.getElementById('selectChofer'), placas: document.getElementById('selectVolqueta'), empresas: document.getElementById('selectEmpresa'), proveedores: document.getElementById('selectProveedor') };
            const titulos = { choferes: '--- Chofer ---', placas: '--- Placa ---', empresas: '--- Empresa ---', proveedores: '--- Proveedor ---' };
            for (const tipo in selectores) {
                const select = selectores[tipo]; if (!select) continue; const valorActual = select.value;
                select.innerHTML = `<option value="" disabled selected>${titulos[tipo]}</option>`;
                listasAdmin[tipo].forEach(item => select.innerHTML += `<option value="${item.nombre}">${item.nombre}</option>`);
                select.value = valorActual;
            }
        }

        function reiniciarFormulario() {
            document.getElementById('consumoForm').reset();
            document.getElementById('registroId').value = '';
            document.getElementById('fecha').valueAsDate = new Date();
            document.getElementById('formularioTitulo').textContent = 'Nuevo Registro';
            document.getElementById('btnGuardar').textContent = 'Guardar Registro';
            poblarSelectores();
        }
        
        async function agregarItemAdmin(tipo, inputElement) {
            const valor = (tipo === 'placas') ? inputElement.value.trim().toUpperCase() : inputElement.value.trim();
            if (valor) {
                const listaNombres = listasAdmin[tipo].map(item => item.nombre.toUpperCase());
                if (listaNombres.includes(valor.toUpperCase())) { alert(`Este valor ya existe.`); return; }
                try {
                    await addDoc(collection(db, tipo), { nombre: valor });
                    inputElement.value = '';
                    await cargarDatosIniciales();
                } catch (error) { console.error("Error agregando:", error); alert("No se pudo agregar."); }
            }
        }

        async function modificarItemAdmin(item, tipo) {
            const valorActual = item.nombre;
            const nuevoValor = prompt(`Modificar "${valorActual}":`, valorActual);
            if (!nuevoValor || nuevoValor.trim() === '' || nuevoValor.trim() === valorActual) return;
            const valorFormateado = (tipo === 'placas') ? nuevoValor.trim().toUpperCase() : nuevoValor.trim();
            const propiedad = { placas: 'volqueta', choferes: 'chofer', empresas: 'empresa', proveedores: 'proveedor' }[tipo];
            if (confirm(`¬øEst√°s seguro de cambiar "${valorActual}" por "${valorFormateado}"? Esto actualizar√° TODOS los registros del historial.`)) {
                try {
                    await updateDoc(doc(db, tipo, item.id), { nombre: valorFormateado });
                    const updates = todosLosConsumos
                        .filter(consumo => consumo[propiedad] === valorActual)
                        .map(consumo => updateDoc(doc(db, "consumos", consumo.id), { [propiedad]: valorFormateado }));
                    await Promise.all(updates);
                    await cargarDatosIniciales();
                } catch(e) { console.error("Error modificando:", e); }
            }
        }

        async function borrarItemAdmin(item, tipo) {
            if (confirm(`¬øSeguro que quieres borrar "${item.nombre}" de la lista de opciones?`)) {
                try {
                    await deleteDoc(doc(db, tipo, item.id));
                    await cargarDatosIniciales();
                } catch(e) { console.error("Error borrando:", e); }
            }
        }

        function mostrarListasAdmin() {
            const contenedores = { choferes: 'listaChoferes', placas: 'listaPlacas', empresas: 'listaEmpresas', proveedores: 'listaProveedores' };
            for (const tipo in contenedores) {
                const ul = document.getElementById(contenedores[tipo]);
                ul.innerHTML = '';
                listasAdmin[tipo].forEach(item => {
                    const li = document.createElement('li');
                    li.innerHTML = `<span>${item.nombre}</span><div><button class="btn-accion btn-modificar">Modificar</button><button class="btn-accion btn-borrar">Borrar</button></div>`;
                    li.querySelector('.btn-modificar').addEventListener('click', () => modificarItemAdmin(item, tipo));
                    li.querySelector('.btn-borrar').addEventListener('click', () => borrarItemAdmin(item, tipo));
                    ul.appendChild(li);
                });
            }
        }

        function calcularYMostrarTotales(consumos) {
            const resumenBody = document.getElementById('resumenBody');
            const resumenFooter = document.getElementById('resumenFooter');
            const totales = {};
            consumos.forEach(c => { if (!totales[c.volqueta]) totales[c.volqueta] = { totalGalones: 0, totalCosto: 0 }; totales[c.volqueta].totalGalones += parseFloat(c.galones); totales[c.volqueta].totalCosto += parseFloat(c.costo); });
            const placasOrdenadas = Object.keys(totales).sort();
            let htmlBody = ''; let granTotalGalones = 0; let granTotalCosto = 0;
            placasOrdenadas.forEach(placa => { const total = totales[placa]; htmlBody += `<tr><td><strong>${placa}</strong></td><td>${total.totalGalones.toFixed(2)}</td><td>$${total.totalCosto.toFixed(2)}</td></tr>`; granTotalGalones += total.totalGalones; granTotalCosto += total.totalCosto; });
            resumenBody.innerHTML = htmlBody;
            resumenFooter.innerHTML = `<tr><td>TOTAL GENERAL</td><td>${granTotalGalones.toFixed(2)}</td><td>$${granTotalCosto.toFixed(2)}</td></tr>`;
            return { labels: placasOrdenadas, data: placasOrdenadas.map(placa => totales[placa].totalCosto) };
        }

        function calcularYMostrarTotalesPorEmpresa(consumos) {
            const resumenBody = document.getElementById('resumenEmpresaBody');
            const resumenFooter = document.getElementById('resumenEmpresaFooter');
            const totales = {};
            consumos.forEach(c => { if (!c.empresa) return; if (!totales[c.empresa]) totales[c.empresa] = { totalGalones: 0, totalCosto: 0 }; totales[c.empresa].totalGalones += parseFloat(c.galones); totales[c.empresa].totalCosto += parseFloat(c.costo); });
            const empresasOrdenadas = Object.keys(totales).sort();
            let htmlBody = ''; let granTotalGalones = 0; let granTotalCosto = 0;
            empresasOrdenadas.forEach(empresa => { const total = totales[empresa]; htmlBody += `<tr><td><strong>${empresa}</strong></td><td>${total.totalGalones.toFixed(2)}</td><td>$${total.totalCosto.toFixed(2)}</td></tr>`; granTotalGalones += total.totalGalones; granTotalCosto += total.totalCosto; });
            resumenBody.innerHTML = htmlBody;
            resumenFooter.innerHTML = `<tr><td>TOTAL GENERAL</td><td>${granTotalGalones.toFixed(2)}</td><td>$${granTotalCosto.toFixed(2)}</td></tr>`;
        }

        function calcularYMostrarTotalesPorProveedor(consumos) {
            const resumenBody = document.getElementById('resumenProveedorBody');
            const resumenFooter = document.getElementById('resumenProveedorFooter');
            const totales = {};
            consumos.forEach(c => { if (!c.proveedor) return; if (!totales[c.proveedor]) totales[c.proveedor] = { totalGalones: 0, totalCosto: 0 }; totales[c.proveedor].totalGalones += parseFloat(c.galones); totales[c.proveedor].totalCosto += parseFloat(c.costo); });
            const proveedoresOrdenados = Object.keys(totales).sort();
            let htmlBody = ''; let granTotalGalones = 0; let granTotalCosto = 0;
            proveedoresOrdenados.forEach(proveedor => { const total = totales[proveedor]; htmlBody += `<tr><td><strong>${proveedor}</strong></td><td>${total.totalGalones.toFixed(2)}</td><td>$${total.totalCosto.toFixed(2)}</td></tr>`; granTotalGalones += total.totalGalones; granTotalCosto += total.totalCosto; });
            resumenBody.innerHTML = htmlBody;
            resumenFooter.innerHTML = `<tr><td>TOTAL GENERAL</td><td>${granTotalGalones.toFixed(2)}</td><td>$${granTotalCosto.toFixed(2)}</td></tr>`;
        }

        function crearOActualizarGrafico(datos) {
            const ctx = document.getElementById('graficoConsumo').getContext('2d');
            if (miGrafico) { miGrafico.destroy(); }
            miGrafico = new Chart(ctx, { type: 'bar', data: { labels: datos.labels, datasets: [{ label: 'Costo Total de Consumo ($)', data: datos.data, backgroundColor: 'rgba(40, 167, 69, 0.7)', borderColor: 'rgba(40, 167, 69, 1)', borderWidth: 1 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { callback: function(value) { return '$' + value.toFixed(2); } } } }, plugins: { legend: { display: true, position: 'top', } } } });
        }
        
        function mostrarHistorialAgrupado(consumos) {
            const historialBody = document.getElementById('historialBody');
            historialBody.innerHTML = '';
            consumos.sort((a,b) => new Date(b.fecha) - new Date(a.fecha) || a.volqueta.localeCompare(b.volqueta));
            let mesAnioActual = "";
            consumos.forEach(consumo => {
                const fechaConsumo = new Date(consumo.fecha + 'T00:00:00');
                const mesAnio = fechaConsumo.toLocaleDateString('es-EC', { month: 'long', year: 'numeric' });
                if (mesAnio !== mesAnioActual) {
                    mesAnioActual = mesAnio;
                    const filaGrupo = document.createElement('tr');
                    filaGrupo.className = 'fila-grupo';
                    filaGrupo.innerHTML = `<td colspan="9">${mesAnioActual.charAt(0).toUpperCase() + mesAnioActual.slice(1)}</td>`;
                    historialBody.appendChild(filaGrupo);
                }
                const filaDato = document.createElement('tr');
                filaDato.innerHTML = `<td>${consumo.fecha}</td> <td>${consumo.chofer}</td> <td>${consumo.volqueta}</td> <td>${consumo.proveedor || ''}</td> <td>${parseFloat(consumo.galones).toFixed(2)}</td> <td>$${parseFloat(consumo.costo).toFixed(2)}</td> <td>${consumo.empresa || ''}</td> <td>${consumo.descripcion}</td> <td class="no-print"><button class="btn-accion btn-modificar" data-id="${consumo.id}" style="background-color: #ffc107; color: black;">Modificar</button><button class="btn-accion btn-borrar" data-id="${consumo.id}" style="background-color: #dc3545; color: white;">Borrar</button></td>`;
                historialBody.appendChild(filaDato);
            });
        }
        
        function poblarFiltroDeMes() {
            const filtroSelect = document.getElementById('filtroMes');
            const consumos = todosLosConsumos;
            const mesesUnicos = [...new Set(consumos.map(c => c.fecha.substring(0, 7)))];
            mesesUnicos.sort().reverse();
            const valorSeleccionado = filtroSelect.value;
            filtroSelect.innerHTML = '<option value="todos">Todos los Meses</option>';
            mesesUnicos.forEach(mes => {
                const [year, month] = mes.split('-');
                const fechaMes = new Date(year, month - 1);
                const nombreMes = fechaMes.toLocaleDateString('es-EC', { month: 'long', year: 'numeric' });
                const opcion = document.createElement('option');
                opcion.value = mes;
                opcion.textContent = nombreMes.charAt(0).toUpperCase() + nombreMes.slice(1);
                filtroSelect.appendChild(opcion);
            });
            filtroSelect.value = valorSeleccionado;
        }

        async function guardarOActualizar(e) { e.preventDefault(); const id = document.getElementById('registroId').value; const datosConsumo = { volqueta: document.getElementById('selectVolqueta').value, fecha: document.getElementById('fecha').value, galones: document.getElementById('galones').value, costo: document.getElementById('costo').value, descripcion: document.getElementById('descripcion').value, chofer: document.getElementById('selectChofer').value, empresa: document.getElementById('selectEmpresa').value, proveedor: document.getElementById('selectProveedor').value }; if (!datosConsumo.chofer || !datosConsumo.volqueta || !datosConsumo.empresa || !datosConsumo.proveedor) { alert("Por favor, seleccione un valor en todos los men√∫s desplegables."); return; } try { if (id) { await updateDoc(doc(db, "consumos", id), datosConsumo); } else { await addDoc(collection(db, "consumos"), datosConsumo); } reiniciarFormulario(); await cargarDatosIniciales(); } catch (error) { console.error("Error guardando:", error); alert("No se pudo guardar el registro."); } }
        function manejarAccionesHistorial(e) { const target = e.target.closest('button'); if (!target) return; const id = target.dataset.id; if (!id) return; if (target.classList.contains('btn-modificar')) cargarDatosParaModificar(id); if (target.classList.contains('btn-borrar')) borrarConsumoHistorial(id); }
        function obtenerConsumosFiltrados() { if (filtroMesActual === 'todos') return todosLosConsumos; return todosLosConsumos.filter(c => c.fecha.startsWith(filtroMesActual)); }
        function cargarDatosParaModificar(id) { const consumo = todosLosConsumos.find(c => c.id === id); if (!consumo) return; document.getElementById('registroId').value = consumo.id; document.getElementById('fecha').value = consumo.fecha; document.getElementById('selectChofer').value = consumo.chofer; document.getElementById('selectVolqueta').value = consumo.volqueta; document.getElementById('galones').value = consumo.galones; document.getElementById('costo').value = consumo.costo; document.getElementById('descripcion').value = consumo.descripcion; document.getElementById('selectEmpresa').value = consumo.empresa || ""; document.getElementById('selectProveedor').value = consumo.proveedor || ""; document.getElementById('formularioTitulo').textContent = 'Modificar Registro'; document.getElementById('btnGuardar').textContent = 'Actualizar Registro'; openMainTab({currentTarget: document.getElementById('btnTabRegistrar')}, 'tabRegistrar'); document.getElementById('formularioContainer').scrollIntoView({ behavior: 'smooth' }); }
        async function borrarConsumoHistorial(id) { if (confirm('¬øSeguro que quieres borrar este registro?')) { try { await deleteDoc(doc(db, "consumos", id)); await cargarDatosIniciales(); } catch (e) { console.error("Error borrando consumo:", e); } } }

        // --- ARRANQUE DE LA APLICACI√ìN ---
        window.addEventListener('DOMContentLoaded', () => {
            iniciarAplicacion();
        });

        function iniciarAplicacion() {
            asignarEventos();
            reiniciarFormulario();
            cargarDatosIniciales();
        }
    </script>
</body>
</html>